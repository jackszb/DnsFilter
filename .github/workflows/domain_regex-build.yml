name: Generate domain_regex.json

on:
  push:
    paths:
      - wildcard.txt
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install required Python libraries
      run: |
        python -m pip install --upgrade pip
        pip install re

    - name: Create Python script to generate domain_regex.json
      run: |
        echo 'import re
import json

def convert_wildcards_to_regex(domain):
    domain = domain.replace("*", ".*")
    domain = re.sub(r"([^.]+)\.([a-z]+)$", r"^\1(\\.[^.]+)*\\.\\2$", domain)
    domain = re.sub(r"^\\*", "^([^.]+\\.)*", domain)
    if not domain.startswith("^"):
        domain = "^" + domain
    if not domain.endswith("$"):
        domain = domain + "$"
    return domain

def generate_sing_box_rule(domains):
    return {"version": 3, "rules": [{"domain_regex": [convert_wildcards_to_regex(domain) for domain in domains]}]}

def read_wildcard_file(filename):
    with open(filename, "r") as file:
        return [line.strip() for line in file.readlines() if line.strip()]

domains = read_wildcard_file("wildcard.txt")
rules = generate_sing_box_rule(domains)

with open("domain_regex.json", "w") as f:
    json.dump(rules, f, indent=2)' > generate_domain_regex.py

    - name: Run Python script to generate domain_regex.json
      run: |
        python generate_domain_regex.py

    - name: Commit and push domain_regex.json
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        git add domain_regex.json
        git commit -m "Auto-generated domain_regex.json"
        git push
